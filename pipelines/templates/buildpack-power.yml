---
resources: ############################################################################################################
  - name: buildpacks-ci-image
    type: docker-image
    source:
      repository: 140.211.168.97:5000/buildpacks/ci
      tag: "latest"
      insecure_registries: ["140.211.168.97:5000"]
      username: {{username}}
      password: {{password}}
  ## Git ##

    <% if language == 'multi' %>
      <% git_repo_organization = 'cloudfoundry-incubator' %>
    <% else %>
      <% git_repo_organization = organization %>
    <% end %>
  - name: buildpack-develop
    type: git
    source:
      uri: git@github.com:<%= git_repo_organization %>/<%= language %>-buildpack.git
      private_key: {{buildpack-private-key}}
      branch: develop
      git_config:
      - name: user.email
        value: {{name}}
      - name: user.name
        value: {{email}}
      ignore_paths:
        - VERSION
        - CHANGELOG
        - "**/*.md"

  - name: buildpack-master
    type: git
    source:
      uri: git@github.com:<%= git_repo_organization %>/<%= language %>-buildpack.git
      private_key: {{buildpack-private-key}}
      branch: master

  - name: buildpacks-ci
    type: git
    source:
      uri: {{buildpacks-ci-git-uri-public}}
      branch: {{buildpacks-ci-git-uri-public-branch}}

  - name: brats
    type: git
    source:
      uri: https://github.com/cloudfoundry/brats.git

<% unless language == 'binary' || language == 'multi' %>
  - name: compile-extensions
    type: git
    source:
      uri: https://github.com/cloudfoundry/compile-extensions.git
<% end %>

#  - name: buildpack-checksums
#    type: git
#    source:
#      uri: git@bitbucket.org:cloudfoundry-buildpacks/buildpack-checksums.git
#      private_key: !!buildpack-checksums-private-key}}
#      branch: master

  ## Github Releases ##

    <% if language == 'multi' %>
      <% github_release_user = 'cloudfoundry-incubator' %>
    <% else %>
      <% github_release_user = '{{buildpacks-github-org}}' %>
    <% end %>
#  - name: buildpack-github-release
#    type: github-release
#    source:
#      user: <%= github_release_user %>
#      repository: <%= language %>-buildpack
#      access_token: !!buildpacks-github-token}}

#  - name: buildpack-packager
#    type: github-release
#    source:
#      user: {{buildpacks-github-org}}
#      repository: buildpack-packager
#    #  access_token: !!buildpacks-github-token}}

#  - name: machete
#    type: github-release
#    source:
#      user: {{buildpacks-github-org}}
#      repository: machete
#      #access_token: !!buildpacks-github-token}}

  ## S3 Buckets ##

  - name: pivotal-buildpack
    type: s3
    source:
      bucket: {{buildpacks-binaries-s3-bucket}}
      regexp: buildpack-release-candidates/<%= language%>/<%= language %>_buildpack-v(.*).zip
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}

  - name: pivotal-buildpack-cached
    type: s3
    source:
      bucket: {{buildpacks-binaries-s3-bucket}}
      regexp: buildpack-release-candidates/<%= language%>/<%= language %>_buildpack-cached-v(.*).zip
      access_key_id: {{pivotal-buildpacks-s3-access-key}}
      secret_access_key: {{pivotal-buildpacks-s3-secret-key}}

  ## Resource Pools ##

  - name: cf-environments
    type: pool
    source:
      branch: resource-pools
      pool: cf-edge-environments
      private_key: {{buildpacks-ci-private-key}}
      uri: {{buildpacks-ci-git-uri}}

jobs: ################################################################################################################
  <% if language == "php" %>
  - name: ensure-manifest-has-modules
    serial: true
    public: true
    plan:
      - get: buildpacks-ci
        tags: [ppc64le]
      - get: buildpacks-ci-image
        tags: [ppc64le]
      - get: buildpack
        tags: [ppc64le]
        resource: buildpack-develop
        trigger: true
      - task: load-modules
        tags: [ppc64le]
        image: buildpacks-ci-image
        file: buildpacks-ci/tasks/populate-php-modules-in-manifest/task-power.yml
        privileged: true
      - put: buildpack-develop
        tags: [ppc64le]
        params:
          repository: updated-buildpack
          rebase: true
  <% end %>
  - name: detect-new-version-and-upload-artifacts
    serial: true
    public: true
    plan:
      - aggregate:
        - get: buildpacks-ci
          tags: [ppc64le]
        - get: buildpack
          tags: [ppc64le]
          resource: buildpack-master
          trigger: true
        - get: pivotal-buildpack-cached
          tags: [ppc64le]
        - get: pivotal-buildpack
          tags: [ppc64le]
        - get: buildpacks-ci-image
          tags: [ppc64le]
      - do:
        - task: detect-and-upload
          tags: [ppc64le]
          file: buildpacks-ci/tasks/detect-and-upload/task.yml
          privileged: true
          image: buildpacks-ci-image
          params:
            GIT_REPO_ORG: <%= git_repo_organization %>
            BUILDPACK_NAME: <%= language %>-buildpack
            RUBYGEM_MIRROR: {{rubygem-mirror}}
        - put: pivotal-buildpack
          tags: [ppc64le]
          params:
            from: buildpack-artifacts/.*_buildpack-v(.*).zip
            to: /buildpack-release-candidates/<%= language %>/
        - put: pivotal-buildpack-cached
          tags: [ppc64le]
          params:
            from: buildpack-artifacts/.*_buildpack-cached-v(.*).zip
            to: /buildpack-release-candidates/<%= language %>/
  - name: specs-edge-master
    serial: true
    public: true
    plan:
      - put: cf-environments
        resource: cf-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
          tags: [ppc64le]
        - get: buildpack
          tags: [ppc64le]
          passed: [ "detect-new-version-and-upload-artifacts" ]
          resource: buildpack-master
          trigger: true
        - get: pivotal-buildpacks
          tags: [ppc64le]
          resource: pivotal-buildpack
          passed: [ "detect-new-version-and-upload-artifacts" ]
          trigger: true
        - get: pivotal-buildpacks-cached
          tags: [ppc64le]
          resource: pivotal-buildpack-cached
          passed: [ "detect-new-version-and-upload-artifacts" ]
          trigger: true
      - do:
        - task: rspec
          tags: [ppc64le]
          file: buildpacks-ci/tasks/run-buildpack-specs/task.yml
          params:
            STACKS: cflinuxfs2
            CF_PASSWORD: {{ci-cf-password}}
            DOMAIN_NAME: 'xip.io'
            DEPLOYMENT_NAME: '140.211.168.170'
            RUBYGEM_MIRROR: {{rubygem-mirror}}
          privileged: true
          ensure:
            put: cf-environments
            params:
              release: cf-environments
  - name: buildpack-release
    serial: true
    public: true
    plan:
      - aggregate:
        - get: buildpacks-ci
          tags: [ppc64le]
        - get: buildpacks-ci-image
          tags: [ppc64le]
        - get: pivotal-buildpacks-cached
          tags: [ppc64le]
          resource: pivotal-buildpack-cached
          passed: [ "specs-edge-master"]
          trigger: true
        - get: buildpack
          tags: [ppc64le]
          passed: [ "specs-edge-master" ]
          resource: buildpack-master
          trigger: true
      - task: check tag not already added
        tags: [ppc64le]
        image: buildpacks-ci-image
        file: buildpacks-ci/tasks/check-tag-not-already-added/task-power.yml
      - put: buildpack-master
        tags: [ppc64le]
        params:
          repository: buildpack
          tag: buildpack/VERSION
          tag_prefix: v
#  - name: buildpack-to-github
#    serial: true
#    public: true
#    plan:
#      - aggregate:
#        - get: buildpacks-ci
#        - get: pivotal-buildpacks-cached
#          resource: pivotal-buildpack-cached
#          passed: [ buildpack-release ]
#        - get: buildpack
#          resource: buildpack-master
#          passed: [ buildpack-release ]
#        - get: buildpack-checksums
#      - task: finalize-buildpack
#        file: buildpacks-ci/tasks/finalize-buildpack/task.yml
#        privileged: true
#      - task: commit-shas
#        file: buildpacks-ci/tasks/get-commit-shasums/task.yml
#        privileged: true
#      - put: buildpack-checksums
#        params:
#          repository: sha-artifacts
#          rebase: true
#      - put: buildpack-github-release
#        params:
#          name: buildpack-artifacts/tag
#          tag: buildpack-artifacts/tag
#          body: buildpack-artifacts/RECENT_CHANGES
#          globs:
#            - buildpack-artifacts/*_buildpack-cached-v*.zip
#            - buildpack-artifacts/*_buildpack-cached-v*.zip.SHA256SUM.txt

  - name: specs-edge-develop
    serial: true
    public: true
    plan:
      - put: cf-environments
        tags: [ppc64le]
        resource: cf-environments
        params:
          acquire: true
      - aggregate:
        - get: buildpacks-ci
          tags: [ppc64le]
        - get: brats
          tags: [ppc64le]
        - get: buildpack
          tags: [ppc64le]
          resource: buildpack-develop
          trigger: true
        - get: buildpacks-ci-image
          tags: [ppc64le]
      - do:
        - task: rspec
          tags: [ppc64le]
          file: buildpacks-ci/tasks/run-buildpack-specs/task.yml
          image: buildpacks-ci-image
          params:
            STACKS: cflinuxfs2
            CF_PASSWORD: {{ci-cf-password}}
            DOMAIN_NAME: 'xip.io'
            DEPLOYMENT_NAME: '140.211.168.170'
            RUBYGEM_MIRROR: {{rubygem-mirror}}
          privileged: true
        - task: brats
          tags: [ppc64le]
          file: buildpacks-ci/tasks/run-brats/task.yml
          privileged: true
          params:
            BRATS_BRANCH: develop
            CI_CF_USERNAME: {{ci-cf-username}}
            CI_CF_PASSWORD: {{ci-cf-password}}
            LANGUAGE: <%= language %>
            RUBYGEM_MIRROR: {{rubygem-mirror}}
            DOMAIN_NAME: 'xip.io'
            DEPLOYMENT_NAME: '140.211.168.170'

        ensure:
          put: cf-environments
          tags: [ppc64le]
          params:
            release: cf-environments

<% unless language == "binary" || language == "multi" %>
  - name: update-compile-extensions
    serial: true
    public: true
    plan:
      - aggregate:
        - get: buildpacks-ci
          tags: [ppc64le]
        - get: compile-extensions
          tags: [ppc64le]
          trigger: true
        - get: buildpack
          tags: [ppc64le]
          resource: buildpack-develop
        - get: buildpacks-ci-image
      - task: update-compile-extensions
        tags: [ppc64le]
        file: buildpacks-ci/tasks/update-compile-extensions/task.yml
        privileged: true
        params: { RUBYGEM_MIRROR: {{rubygem-mirror}}  }
        image: buildpacks-ci-image
      - put: buildpack-develop
        tags: [ppc64le]
        params:
          repository: buildpack-artifacts
          rebase: true
<% end %>
#  - name: update-buildpack-packager
#    serial: true
#    public: true
#    plan:
#      - aggregate:
#        - get: buildpacks-ci
#        - get: gem
#          resource: buildpack-packager
#          trigger: true
#        - get: repo-with-gemfile
#          resource: buildpack-develop
#      - task: update-buildpack-packager
#        file: buildpacks-ci/tasks/update-gem-in-gemfile/task.yml
#        privileged: true
#        params:
#          RUBYGEM_MIRROR: {{rubygem-mirror}}
#          GEM_NAME: buildpack-packager
#          GEM_GIT_REPOSITORY: !!buildpack-packager-git-uri-public}}
#          GEMFILE_NAME: cf.Gemfile
#      - put: buildpack-develop
#        params:
#          repository: repo-with-gemfile-artifacts
#          rebase: true
#  - name: update-machete
#    serial: true
#    public: true
#    plan:
#      - aggregate:
#        - get: buildpacks-ci
#          tags: [ppc64le]
#        - get: buildpacks-ci-image
#          tags: [ppc64le]
#        - get: gem
#          tags: [ppc64le]
#          resource: machete
#          trigger: true
#        - get: repo-with-gemfile
#          tags: [ppc64le]
#          resource: buildpack-develop
#      - task: update-machete
#        tags: [ppc64le]
#        image: buildpacks-ci-image
#        file: buildpacks-ci/tasks/update-gem-in-gemfile/task-power.yml
#        privileged: true
#        params:
#          RUBYGEM_MIRROR: {{rubygem-mirror}}
#          GEM_NAME: machete
#          GEM_GIT_REPOSITORY: {{machete-git-uri-public}}
#          GEMFILE_NAME: cf.Gemfile
#      - put: buildpack-develop
#        tags: [ppc64le]
#        params:
#          repository: repo-with-gemfile-artifacts
#          rebase: true
